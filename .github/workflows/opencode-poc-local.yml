name: OpenCode PoC - Local Binary

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  opencode-test-local:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use existing OpenCode installation
        run: |
          echo "üîç Checking for existing OpenCode installation..."
          
          # Check if opencode is available in PATH
          if command -v opencode >/dev/null 2>&1; then
            echo "‚úÖ OpenCode found in PATH"
            OPENCODE_PATH=$(which opencode)
            echo "üìç OpenCode location: $OPENCODE_PATH"
          else
            echo "‚ùå OpenCode not found in PATH"
            echo "üîç Checking common installation locations..."
            
            # Check common installation paths
            for path in "$HOME/.opencode/bin/opencode" "/usr/local/bin/opencode" "/opt/opencode/bin/opencode"; do
              if [ -x "$path" ]; then
                echo "‚úÖ Found OpenCode at: $path"
                OPENCODE_PATH="$path"
                export PATH="$(dirname "$path"):$PATH"
                break
              fi
            done
            
            if [ -z "$OPENCODE_PATH" ]; then
              echo "‚ùå OpenCode not found. Please install OpenCode first."
              exit 1
            fi
          fi

      - name: Configure OpenCode  
        run: |
          mkdir -p "$HOME/.config/opencode"
          cp .github/opencode/config.json "$HOME/.config/opencode/config.json"
          
          echo "‚úÖ Configured OpenCode with big-pickle model support"

      - name: Test OpenCode functionality
        run: |
          echo "üß™ Testing OpenCode with big-pickle model..."
          
          # Test version
          echo "üìã OpenCode version:"
          if opencode --version; then
            echo "‚úÖ Version command successful"
          else
            echo "‚ö†Ô∏è  Version command failed, but continuing..."
          fi
          
          # Test actual functionality
          echo ""
          echo "üöÄ Testing OpenCode run command..."
          if opencode run 'Say: ‚úÖ SUCCESS! OpenCode is working perfectly with big-pickle model in GitHub Actions!'; then
            echo "‚úÖ OpenCode run command successful!"
          else
            echo "‚ùå OpenCode run command failed"
            exit 1
          fi

      - name: Display success message
        run: |
          echo "üéâ OpenCode PoC (Local Binary) Completed Successfully!"
          echo "‚úÖ OpenCode was found and configured"
          echo "‚úÖ Using big-pickle model (no API key required)"
          echo "‚úÖ OpenCode functionality verified"
          echo "üöÄ This proves OpenCode can work perfectly in GitHub Actions workflows!"