name: Enhanced OpenCode Test

on:
  push:
  workflow_dispatch:

jobs:
  security-review:
    uses: ./.github/workflows/opencode-run.yml
    with:
      run-name: security
      prompt-file: .opencode/commands/security-review.md
      timeout-minutes: 10

  safety-review:
    uses: ./.github/workflows/opencode-run.yml
    with:
      run-name: safety
      prompt-file: .opencode/commands/safety-review.md
      timeout-minutes: 10

  summary:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: [security-review, safety-review]
    if: always()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Security Review Results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: security-results

      - name: Download Safety Review Results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: safety-results

      - name: Create Combined Report
        env:
          REPORT_TITLE: "Enhanced OpenCode Review Summary"
        run: |
          .github/scripts/generate-report.sh basic security safety

      - name: Upload Combined Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: combined-review-report
          path: combined-report.md