name: Comprehensive Review Test

on:
  push:
  workflow_dispatch:

env:
  CACHE_KEY_PREFIX: opencode
  OPENCODE_MODEL: opencode/big-pickle

jobs:
  # ==========================================
  # üîí SECURITY & COMPLIANCE STREAM
  # ==========================================
  
  security-review:
    uses: ./.github/workflows/opencode-review.yml
    with:
      review-name: security
      prompt-file: .github/prompts/security.prompt.md
      timeout-minutes: 10
      use-cache: true
      cache-key: ${{ format('opencode-{0}-{1}', runner.os, github.run_id) }}
      opencode-model: ${{ env.OPENCODE_MODEL }}

  compliance-review:
    uses: ./.github/workflows/opencode-review.yml
    needs: [security-review]
    with:
      review-name: compliance
      prompt-file: .github/prompts/compliance.prompt.md
      timeout-minutes: 18
      use-cache: true
      cache-key: ${{ format('opencode-{0}-{1}', runner.os, github.run_id) }}
      opencode-model: ${{ env.OPENCODE_MODEL }}

  safety-review:
    uses: ./.github/workflows/opencode-review.yml
    needs: [compliance-review]
    with:
      review-name: safety
      prompt-file: .github/prompts/safety.prompt.md
      timeout-minutes: 10
      use-cache: true
      cache-key: ${{ format('opencode-{0}-{1}', runner.os, github.run_id) }}
      opencode-model: ${{ env.OPENCODE_MODEL }}

  # ==========================================
  # üìñ CODE QUALITY STREAM
  # ==========================================

  readability-review:
    uses: ./.github/workflows/opencode-review.yml
    with:
      review-name: readability
      prompt-file: .github/prompts/readability.prompt.md
      timeout-minutes: 8
      use-cache: true
      cache-key: ${{ format('opencode-{0}-{1}', runner.os, github.run_id) }}
      opencode-model: ${{ env.OPENCODE_MODEL }}

  efficiency-review:
    uses: ./.github/workflows/opencode-review.yml
    needs: [readability-review]
    with:
      review-name: efficiency
      prompt-file: .github/prompts/efficiency.prompt.md
      timeout-minutes: 10
      use-cache: true
      cache-key: ${{ format('opencode-{0}-{1}', runner.os, github.run_id) }}
      opencode-model: ${{ env.OPENCODE_MODEL }}

  performance-review:
    uses: ./.github/workflows/opencode-review.yml
    needs: [efficiency-review]
    with:
      review-name: performance
      prompt-file: .github/prompts/performance.prompt.md
      timeout-minutes: 15
      use-cache: true
      cache-key: ${{ format('opencode-{0}-{1}', runner.os, github.run_id) }}
      opencode-model: ${{ env.OPENCODE_MODEL }}

  # ==========================================
  # üèóÔ∏è ARCHITECTURE STREAM
  # ==========================================

  architecture-review:
    uses: ./.github/workflows/opencode-review.yml
    with:
      review-name: architecture
      prompt-file: .github/prompts/architecture.prompt.md
      timeout-minutes: 20
      use-cache: true
      cache-key: ${{ format('opencode-{0}-{1}', runner.os, github.run_id) }}
      opencode-model: ${{ env.OPENCODE_MODEL }}

  scalability-review:
    uses: ./.github/workflows/opencode-review.yml
    needs: [architecture-review]
    with:
      review-name: scalability
      prompt-file: .github/prompts/scalability.prompt.md
      timeout-minutes: 15
      use-cache: true
      cache-key: ${{ format('opencode-{0}-{1}', runner.os, github.run_id) }}
      opencode-model: ${{ env.OPENCODE_MODEL }}

  modularity-review:
    uses: ./.github/workflows/opencode-review.yml
    needs: [scalability-review]
    with:
      review-name: modularity
      prompt-file: .github/prompts/modularity.prompt.md
      timeout-minutes: 10
      use-cache: true
      cache-key: ${{ format('opencode-{0}-{1}', runner.os, github.run_id) }}
      opencode-model: ${{ env.OPENCODE_MODEL }}

  # ==========================================
  # üë§ USER EXPERIENCE STREAM
  # ==========================================

  usability-review:
    uses: ./.github/workflows/opencode-review.yml
    with:
      review-name: usability
      prompt-file: .github/prompts/usability.prompt.md
      timeout-minutes: 10
      use-cache: true
      cache-key: ${{ format('opencode-{0}-{1}', runner.os, github.run_id) }}
      opencode-model: ${{ env.OPENCODE_MODEL }}

  accessibility-review:
    uses: ./.github/workflows/opencode-review.yml
    needs: [usability-review]
    with:
      review-name: accessibility
      prompt-file: .github/prompts/accessibility.prompt.md
      timeout-minutes: 12
      use-cache: true
      cache-key: ${{ format('opencode-{0}-{1}', runner.os, github.run_id) }}
      opencode-model: ${{ env.OPENCODE_MODEL }}

  documentation-review:
    uses: ./.github/workflows/opencode-review.yml
    needs: [accessibility-review]
    with:
      review-name: documentation
      prompt-file: .github/prompts/documentation.prompt.md
      timeout-minutes: 8
      use-cache: true
      cache-key: ${{ format('opencode-{0}-{1}', runner.os, github.run_id) }}
      opencode-model: ${{ env.OPENCODE_MODEL }}

  # ==========================================
  # üîÄ CROSS-STREAM CONVERGENCE
  # ==========================================

  reliability-review:
    uses: ./.github/workflows/opencode-review.yml
    needs: [performance-review, modularity-review]
    with:
      review-name: reliability
      prompt-file: .github/prompts/reliability.prompt.md
      timeout-minutes: 15
      use-cache: true
      cache-key: ${{ format('opencode-{0}-{1}', runner.os, github.run_id) }}
      opencode-model: ${{ env.OPENCODE_MODEL }}

  testability-review:
    uses: ./.github/workflows/opencode-review.yml
    needs: [modularity-review, safety-review]
    with:
      review-name: testability
      prompt-file: .github/prompts/testability.prompt.md
      timeout-minutes: 12
      use-cache: true
      cache-key: ${{ format('opencode-{0}-{1}', runner.os, github.run_id) }}
      opencode-model: ${{ env.OPENCODE_MODEL }}

  maintainability-review:
    uses: ./.github/workflows/opencode-review.yml
    needs: [documentation-review, performance-review, safety-review]
    with:
      review-name: maintainability
      prompt-file: .github/prompts/maintainability.prompt.md
      timeout-minutes: 12
      use-cache: true
      cache-key: ${{ format('opencode-{0}-{1}', runner.os, github.run_id) }}
      opencode-model: ${{ env.OPENCODE_MODEL }}

  compatibility-review:
    uses: ./.github/workflows/opencode-review.yml
    needs: [reliability-review, testability-review]
    with:
      review-name: compatibility
      prompt-file: .github/prompts/compatibility.prompt.md
      timeout-minutes: 12
      use-cache: true
      cache-key: ${{ format('opencode-{0}-{1}', runner.os, github.run_id) }}
      opencode-model: ${{ env.OPENCODE_MODEL }}

  # ==========================================
  # üéØ FINAL COMPREHENSIVE SUMMARY
  # ==========================================

  summary:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [
      # Security & Compliance Stream
      security-review, compliance-review, safety-review,
      # Code Quality Stream  
      readability-review, efficiency-review, performance-review,
      # Architecture Stream
      architecture-review, scalability-review, modularity-review,
      # User Experience Stream
      usability-review, accessibility-review, documentation-review,
      # Cross-Stream Convergence
      reliability-review, testability-review, maintainability-review, compatibility-review
    ]
    if: always()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Review Results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: "*-review-results"
          merge-multiple: true

      - name: Create Multi-Stream Report  
        run: |
          .github/scripts/generate-report.sh multistream

      - name: Upload Multi-Stream Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: comprehensive-multi-stream-report
          path: comprehensive-report.md

      - name: Generate Stream Statistics
        env:
          STATS_FILE: "stream-stats.txt"
        run: |
          .github/scripts/generate-report.sh stats security compliance safety readability efficiency performance architecture scalability modularity usability accessibility documentation reliability testability maintainability compatibility

      - name: Upload Stream Statistics
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: multi-stream-statistics
          path: stream-stats.txt