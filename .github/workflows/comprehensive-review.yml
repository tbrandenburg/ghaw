name: Comprehensive Review Test

on:
  push:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    outputs:
      opencode-cache-key: ${{ steps.cache-key.outputs.key }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate cache key
        id: cache-key
        run: |
          echo "key=opencode-$(runner.os)-$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Cache OpenCode installation
        id: cache-opencode
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ steps.cache-key.outputs.key }}

      - name: Install OpenCode
        if: steps.cache-opencode.outputs.cache-hit != 'true'
        run: |
          curl -fsSL https://opencode.ai/install | bash

      - name: Configure OpenCode
        if: steps.cache-opencode.outputs.cache-hit != 'true'
        run: |
          mkdir -p "$HOME/.config/opencode"
          cp .github/opencode/config.json "$HOME/.config/opencode/config.json"

      - name: Test OpenCode Installation
        run: |
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
          opencode --version

  # ==========================================
  # ðŸ”’ SECURITY & COMPLIANCE STREAM
  # ==========================================
  
  security-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: setup
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Restore OpenCode from cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ needs.setup.outputs.opencode-cache-key }}
          fail-on-cache-miss: true
      - name: Setup OpenCode PATH
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Security Review
        run: |
          SECURITY_PROMPT=$(cat .github/prompts/security.prompt.md)
          echo "$SECURITY_PROMPT" | opencode run --model "opencode/big-pickle" > security-review-results.txt
      - name: Upload Security Review Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-review-results
          path: security-review-results.txt

  compliance-review:
    runs-on: ubuntu-latest
    timeout-minutes: 18
    needs: [setup, security-review]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Restore OpenCode from cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ needs.setup.outputs.opencode-cache-key }}
          fail-on-cache-miss: true
      - name: Setup OpenCode PATH
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Compliance Review
        run: |
          COMPLIANCE_PROMPT=$(cat .github/prompts/compliance.prompt.md)
          echo "$COMPLIANCE_PROMPT" | opencode run --model "opencode/big-pickle" > compliance-review-results.txt
      - name: Upload Compliance Review Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compliance-review-results
          path: compliance-review-results.txt

  safety-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [setup, compliance-review]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Restore OpenCode from cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ needs.setup.outputs.opencode-cache-key }}
          fail-on-cache-miss: true
      - name: Setup OpenCode PATH
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Safety Review
        run: |
          SAFETY_PROMPT=$(cat .github/prompts/safety.prompt.md)
          echo "$SAFETY_PROMPT" | opencode run --model "opencode/big-pickle" > safety-review-results.txt
      - name: Upload Safety Review Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safety-review-results
          path: safety-review-results.txt

  # ==========================================
  # ðŸ“– CODE QUALITY STREAM
  # ==========================================

  readability-review:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: setup
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Restore OpenCode from cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ needs.setup.outputs.opencode-cache-key }}
          fail-on-cache-miss: true
      - name: Setup OpenCode PATH
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Readability Review
        run: |
          READABILITY_PROMPT=$(cat .github/prompts/readability.prompt.md)
          echo "$READABILITY_PROMPT" | opencode run --model "opencode/big-pickle" > readability-review-results.txt
      - name: Upload Readability Review Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: readability-review-results
          path: readability-review-results.txt

  efficiency-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [setup, readability-review]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Restore OpenCode from cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ needs.setup.outputs.opencode-cache-key }}
          fail-on-cache-miss: true
      - name: Setup OpenCode PATH
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Efficiency Review
        run: |
          EFFICIENCY_PROMPT=$(cat .github/prompts/efficiency.prompt.md)
          echo "$EFFICIENCY_PROMPT" | opencode run --model "opencode/big-pickle" > efficiency-review-results.txt
      - name: Upload Efficiency Review Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: efficiency-review-results
          path: efficiency-review-results.txt

  performance-review:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [setup, efficiency-review]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Restore OpenCode from cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ needs.setup.outputs.opencode-cache-key }}
          fail-on-cache-miss: true
      - name: Setup OpenCode PATH
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Performance Review
        run: |
          PERFORMANCE_PROMPT=$(cat .github/prompts/performance.prompt.md)
          echo "$PERFORMANCE_PROMPT" | opencode run --model "opencode/big-pickle" > performance-review-results.txt
      - name: Upload Performance Review Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-review-results
          path: performance-review-results.txt

  # ==========================================
  # ðŸ—ï¸ ARCHITECTURE STREAM
  # ==========================================

  architecture-review:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: setup
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Restore OpenCode from cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ needs.setup.outputs.opencode-cache-key }}
          fail-on-cache-miss: true
      - name: Setup OpenCode PATH
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Architecture Review
        run: |
          ARCHITECTURE_PROMPT=$(cat .github/prompts/architecture.prompt.md)
          echo "$ARCHITECTURE_PROMPT" | opencode run --model "opencode/big-pickle" > architecture-review-results.txt
      - name: Upload Architecture Review Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: architecture-review-results
          path: architecture-review-results.txt

  scalability-review:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [setup, architecture-review]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Restore OpenCode from cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ needs.setup.outputs.opencode-cache-key }}
          fail-on-cache-miss: true
      - name: Setup OpenCode PATH
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Scalability Review
        run: |
          SCALABILITY_PROMPT=$(cat .github/prompts/scalability.prompt.md)
          echo "$SCALABILITY_PROMPT" | opencode run --model "opencode/big-pickle" > scalability-review-results.txt
      - name: Upload Scalability Review Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scalability-review-results
          path: scalability-review-results.txt

  modularity-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [setup, scalability-review]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Restore OpenCode from cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ needs.setup.outputs.opencode-cache-key }}
          fail-on-cache-miss: true
      - name: Setup OpenCode PATH
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Modularity Review
        run: |
          MODULARITY_PROMPT=$(cat .github/prompts/modularity.prompt.md)
          echo "$MODULARITY_PROMPT" | opencode run --model "opencode/big-pickle" > modularity-review-results.txt
      - name: Upload Modularity Review Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: modularity-review-results
          path: modularity-review-results.txt

  # ==========================================
  # ðŸ‘¤ USER EXPERIENCE STREAM
  # ==========================================

  usability-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: setup
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Restore OpenCode from cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ needs.setup.outputs.opencode-cache-key }}
          fail-on-cache-miss: true
      - name: Setup OpenCode PATH
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Usability Review
        run: |
          USABILITY_PROMPT=$(cat .github/prompts/usability.prompt.md)
          echo "$USABILITY_PROMPT" | opencode run --model "opencode/big-pickle" > usability-review-results.txt
      - name: Upload Usability Review Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: usability-review-results
          path: usability-review-results.txt

  accessibility-review:
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: [setup, usability-review]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Restore OpenCode from cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ needs.setup.outputs.opencode-cache-key }}
          fail-on-cache-miss: true
      - name: Setup OpenCode PATH
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Accessibility Review
        run: |
          ACCESSIBILITY_PROMPT=$(cat .github/prompts/accessibility.prompt.md)
          echo "$ACCESSIBILITY_PROMPT" | opencode run --model "opencode/big-pickle" > accessibility-review-results.txt
      - name: Upload Accessibility Review Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-review-results
          path: accessibility-review-results.txt

  documentation-review:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: [setup, accessibility-review]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Restore OpenCode from cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ needs.setup.outputs.opencode-cache-key }}
          fail-on-cache-miss: true
      - name: Setup OpenCode PATH
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Documentation Review
        run: |
          DOCUMENTATION_PROMPT=$(cat .github/prompts/documentation.prompt.md)
          echo "$DOCUMENTATION_PROMPT" | opencode run --model "opencode/big-pickle" > documentation-review-results.txt
      - name: Upload Documentation Review Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: documentation-review-results
          path: documentation-review-results.txt

  # ==========================================
  # ðŸ”€ CROSS-STREAM CONVERGENCE
  # ==========================================

  reliability-review:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [setup, performance-review, modularity-review]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Restore OpenCode from cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ needs.setup.outputs.opencode-cache-key }}
          fail-on-cache-miss: true
      - name: Setup OpenCode PATH
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Reliability Review
        run: |
          RELIABILITY_PROMPT=$(cat .github/prompts/reliability.prompt.md)
          echo "$RELIABILITY_PROMPT" | opencode run --model "opencode/big-pickle" > reliability-review-results.txt
      - name: Upload Reliability Review Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: reliability-review-results
          path: reliability-review-results.txt

  testability-review:
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: [setup, modularity-review, safety-review]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Restore OpenCode from cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ needs.setup.outputs.opencode-cache-key }}
          fail-on-cache-miss: true
      - name: Setup OpenCode PATH
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Testability Review
        run: |
          TESTABILITY_PROMPT=$(cat .github/prompts/testability.prompt.md)
          echo "$TESTABILITY_PROMPT" | opencode run --model "opencode/big-pickle" > testability-review-results.txt
      - name: Upload Testability Review Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: testability-review-results
          path: testability-review-results.txt

  maintainability-review:
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: [setup, documentation-review, performance-review, safety-review]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Restore OpenCode from cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ needs.setup.outputs.opencode-cache-key }}
          fail-on-cache-miss: true
      - name: Setup OpenCode PATH
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Maintainability Review
        run: |
          MAINTAINABILITY_PROMPT=$(cat .github/prompts/maintainability.prompt.md)
          echo "$MAINTAINABILITY_PROMPT" | opencode run --model "opencode/big-pickle" > maintainability-review-results.txt
      - name: Upload Maintainability Review Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: maintainability-review-results
          path: maintainability-review-results.txt

  compatibility-review:
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: [setup, reliability-review, testability-review]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Restore OpenCode from cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ needs.setup.outputs.opencode-cache-key }}
          fail-on-cache-miss: true
      - name: Setup OpenCode PATH
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Compatibility Review
        run: |
          COMPATIBILITY_PROMPT=$(cat .github/prompts/compatibility.prompt.md)
          echo "$COMPATIBILITY_PROMPT" | opencode run --model "opencode/big-pickle" > compatibility-review-results.txt
      - name: Upload Compatibility Review Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compatibility-review-results
          path: compatibility-review-results.txt

  # ==========================================
  # ðŸŽ¯ FINAL COMPREHENSIVE SUMMARY
  # ==========================================

  summary:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [
      # Security & Compliance Stream
      security-review, compliance-review, safety-review,
      # Code Quality Stream  
      readability-review, efficiency-review, performance-review,
      # Architecture Stream
      architecture-review, scalability-review, modularity-review,
      # User Experience Stream
      usability-review, accessibility-review, documentation-review,
      # Cross-Stream Convergence
      reliability-review, testability-review, maintainability-review, compatibility-review
    ]
    if: always()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Review Results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: "*-review-results"
          merge-multiple: true

      - name: Create Multi-Stream Report
        run: |
          echo "# ðŸ¤¯ Comprehensive Review Multi-Stream Report" > comprehensive-report.md
          echo "" >> comprehensive-report.md
          echo "Generated on $(date)" >> comprehensive-report.md
          echo "" >> comprehensive-report.md
          echo "## ðŸŒŠ Multi-Stream Pipeline Architecture" >> comprehensive-report.md
          echo "" >> comprehensive-report.md
          echo "This review uses a **sophisticated multi-stream parallel architecture**:" >> comprehensive-report.md
          echo "" >> comprehensive-report.md
          
          echo "### ðŸ”’ Security & Compliance Stream" >> comprehensive-report.md
          echo "Security â†’ Compliance â†’ Safety" >> comprehensive-report.md
          echo "" >> comprehensive-report.md
          
          echo "### ðŸ“– Code Quality Stream" >> comprehensive-report.md  
          echo "Readability â†’ Efficiency â†’ Performance" >> comprehensive-report.md
          echo "" >> comprehensive-report.md
          
          echo "### ðŸ—ï¸ Architecture Stream" >> comprehensive-report.md
          echo "Architecture â†’ Scalability â†’ Modularity" >> comprehensive-report.md
          echo "" >> comprehensive-report.md
          
          echo "### ðŸ‘¤ User Experience Stream" >> comprehensive-report.md
          echo "Usability â†’ Accessibility â†’ Documentation" >> comprehensive-report.md
          echo "" >> comprehensive-report.md
          
          echo "### ðŸ”€ Cross-Stream Convergence" >> comprehensive-report.md
          echo "Multi-stream dependencies create sophisticated quality gates" >> comprehensive-report.md
          echo "" >> comprehensive-report.md
          
          # Process results by stream
          declare -A streams=(
            ["Security & Compliance"]="security compliance safety"
            ["Code Quality"]="readability efficiency performance"
            ["Architecture"]="architecture scalability modularity"
            ["User Experience"]="usability accessibility documentation"
            ["Cross-Stream"]="reliability testability maintainability compatibility"
          )
          
          for stream in "${!streams[@]}"; do
            echo "## ðŸŒŠ $stream Stream Results" >> comprehensive-report.md
            echo "" >> comprehensive-report.md
            
            for review in ${streams[$stream]}; do
              echo "### ðŸ” ${review^} Review" >> comprehensive-report.md
              if [ -f "${review}-review-results.txt" ]; then
                echo "\`\`\`" >> comprehensive-report.md
                head -n 50 "${review}-review-results.txt" >> comprehensive-report.md
                echo "\`\`\`" >> comprehensive-report.md
              else
                echo "âŒ ${review^} review failed or did not produce results." >> comprehensive-report.md
              fi
              echo "" >> comprehensive-report.md
            done
          done
          
          echo "---" >> comprehensive-report.md
          echo "*ðŸš€ Generated by the Comprehensive Multi-Stream Review System*" >> comprehensive-report.md

      - name: Upload Multi-Stream Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: comprehensive-multi-stream-report
          path: comprehensive-report.md

      - name: Generate Stream Statistics
        run: |
          echo "ðŸ“Š Multi-Stream Review Statistics:" > stream-stats.txt
          echo "=================================" >> stream-stats.txt
          echo "ðŸŒŠ 4 Parallel Streams + Cross-Stream Convergence" >> stream-stats.txt
          echo "" >> stream-stats.txt
          
          declare -A streams=(
            ["ðŸ”’ Security & Compliance"]="security compliance safety"
            ["ðŸ“– Code Quality"]="readability efficiency performance"  
            ["ðŸ—ï¸ Architecture"]="architecture scalability modularity"
            ["ðŸ‘¤ User Experience"]="usability accessibility documentation"
            ["ðŸ”€ Cross-Stream"]="reliability testability maintainability compatibility"
          )
          
          total_success=0
          total_reviews=16
          
          for stream in "${!streams[@]}"; do
            echo "$stream Stream:" >> stream-stats.txt
            stream_success=0
            stream_total=0
            
            for review in ${streams[$stream]}; do
              stream_total=$((stream_total + 1))
              if [ -f "${review}-review-results.txt" ]; then
                stream_success=$((stream_success + 1))
                total_success=$((total_success + 1))
                echo "  âœ… ${review^}: SUCCESS" >> stream-stats.txt
              else
                echo "  âŒ ${review^}: FAILED" >> stream-stats.txt
              fi
            done
            echo "  Stream Success: ${stream_success}/${stream_total}" >> stream-stats.txt
            echo "" >> stream-stats.txt
          done
          
          echo "ðŸŽ¯ OVERALL MULTI-STREAM PIPELINE" >> stream-stats.txt
          echo "===============================" >> stream-stats.txt
          echo "Total Success Rate: ${total_success}/${total_reviews} ($(echo "scale=1; $total_success * 100 / $total_reviews" | bc -l)%)" >> stream-stats.txt
          echo "" >> stream-stats.txt
          echo "ðŸŒŠ Multi-stream parallel execution with cross-dependencies!" >> stream-stats.txt
          
          cat stream-stats.txt

      - name: Upload Stream Statistics
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: multi-stream-statistics
          path: stream-stats.txt

