name: OpenCode Review (Reusable)

on:
  workflow_call:
    inputs:
      review-name:
        description: 'Name of the review (e.g., security, safety, performance)'
        required: true
        type: string
      prompt:
        description: 'The prompt content to use for the review (mutually exclusive with prompt-file)'
        required: false
        type: string
      prompt-file:
        description: 'Path to the prompt file (e.g., .github/prompts/security.prompt.md) (mutually exclusive with prompt)'
        required: false
        type: string
      timeout-minutes:
        description: 'Timeout for the review job in minutes'
        required: false
        type: number
        default: 10
      use-cache:
        description: 'Whether to use OpenCode caching (true) or fresh install (false)'
        required: false
        type: boolean
        default: false
      cache-key:
        description: 'Cache key for OpenCode installation (only used when use-cache is true)'
        required: false
        type: string
      opencode-model:
        description: 'OpenCode model to use for the review'
        required: false
        type: string
        default: 'opencode/big-pickle'
      agent:
        description: 'Agent to use for OpenCode run'
        required: false
        type: string
        default: 'build'
      runner:
        description: 'Runner to use for the job'
        required: false
        type: string
        default: 'ubuntu-latest'

env:
  OPENCODE_INSTALL_URL: 'https://opencode.ai/install'
  MAX_OUTPUT_LINES: 50

jobs:
  review:
    runs-on: ${{ inputs.runner }}
    timeout-minutes: ${{ inputs.timeout-minutes }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Conditional: Use cache if specified
      - name: Restore OpenCode from cache
        if: ${{ inputs.use-cache }}
        id: cache-restore
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ inputs.cache-key }}

      # Conditional: Fresh install if not using cache OR cache miss
      - name: Install OpenCode
        if: ${{ !inputs.use-cache || (inputs.use-cache && steps.cache-restore.outputs.cache-hit != 'true') }}
        run: |
          echo "Installing OpenCode..."
          curl -fsSL ${{ env.OPENCODE_INSTALL_URL }} | bash
          echo "OpenCode installation completed"

      - name: Setup OpenCode PATH
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Test OpenCode Installation
        run: |
          env -i PATH="$HOME/.opencode/bin:$PATH" HOME="$HOME" opencode --version

      - name: Run ${{ inputs.review-name }} Review
        run: |
          if [ -n "${{ inputs.prompt }}" ]; then
            echo "${{ inputs.prompt }}" | env -i PATH="$HOME/.opencode/bin:$PATH" HOME="$HOME" opencode run --model "${{ inputs.opencode-model }}" --agent "${{ inputs.agent }}" > ${{ inputs.review-name }}-review-results.txt
          elif [ -n "${{ inputs.prompt-file }}" ]; then
            PROMPT=$(cat ${{ inputs.prompt-file }})
            echo "$PROMPT" | env -i PATH="$HOME/.opencode/bin:$PATH" HOME="$HOME" opencode run --model "${{ inputs.opencode-model }}" --agent "${{ inputs.agent }}" > ${{ inputs.review-name }}-review-results.txt
          else
            echo "Error: Either 'prompt' or 'prompt-file' input must be provided" >&2
            exit 1
          fi

      - name: Upload ${{ inputs.review-name }} Review Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ inputs.review-name }}-review-results
          path: ${{ inputs.review-name }}-review-results.txt