name: OpenCode Run (Reusable)

on:
  workflow_call:
    inputs:
      run-name:
        description: 'Name of the run (e.g., security, safety, performance)'
        required: true
        type: string
      prompt:
        description: 'The prompt content to use for the run (mutually exclusive with prompt-file)'
        required: false
        type: string
      prompt-file:
        description: 'Path to the prompt file (e.g., .github/prompts/security.prompt.md) (mutually exclusive with prompt)'
        required: false
        type: string
      timeout-minutes:
        description: 'Timeout for the run job in minutes'
        required: false
        type: number
        default: 120
      model:
        description: 'OpenCode model to use for the run'
        required: false
        type: string
        default: 'opencode/big-pickle'
      agent:
        description: 'Agent to use for OpenCode run'
        required: false
        type: string
        default: 'build'
      command:
        description: 'Command to use for OpenCode run (alternative to prompt/prompt-file)'
        required: false
        type: string
      runner:
        description: 'Runner to use for the job'
        required: false
        type: string
        default: 'ubuntu-latest'

env:
  OPENCODE_INSTALL_URL: 'https://opencode.ai/install'
  MAX_OUTPUT_LINES: 50

jobs:
  run:
    runs-on: ${{ inputs.runner }}
    timeout-minutes: ${{ inputs.timeout-minutes }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup and Install OpenCode
        run: |
          # Add OpenCode to PATH first
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
          
          # Check if OpenCode is already installed and working
          if command -v opencode >/dev/null 2>&1 && opencode --version >/dev/null 2>&1; then
            echo "OpenCode is already installed and working"
            opencode --version
          else
            echo "OpenCode not found or not working, installing..."
            curl -fsSL ${{ env.OPENCODE_INSTALL_URL }} | bash
            echo "OpenCode installation completed"
            # Verify installation
            env -i PATH="$HOME/.opencode/bin:$PATH" HOME="$HOME" opencode --version
          fi

      - name: Run OpenCode ${{ inputs.run-name }}
        run: |
          if [ -n "${{ inputs.command }}" ]; then
            if [ -n "${{ inputs.prompt }}" ]; then
              echo "${{ inputs.prompt }}" | env -i PATH="$HOME/.opencode/bin:$PATH" HOME="$HOME" opencode run --command "${{ inputs.command }}" --model "${{ inputs.model }}" --agent "${{ inputs.agent }}" > ${{ inputs.run-name }}-results.txt
            elif [ -n "${{ inputs.prompt-file }}" ]; then
              PROMPT=$(cat ${{ inputs.prompt-file }})
              echo "$PROMPT" | env -i PATH="$HOME/.opencode/bin:$PATH" HOME="$HOME" opencode run --command "${{ inputs.command }}" --model "${{ inputs.model }}" --agent "${{ inputs.agent }}" > ${{ inputs.run-name }}-results.txt
            else
              env -i PATH="$HOME/.opencode/bin:$PATH" HOME="$HOME" opencode run --command "${{ inputs.command }}" --model "${{ inputs.model }}" --agent "${{ inputs.agent }}" > ${{ inputs.run-name }}-results.txt
            fi
          elif [ -n "${{ inputs.prompt }}" ]; then
            echo "${{ inputs.prompt }}" | env -i PATH="$HOME/.opencode/bin:$PATH" HOME="$HOME" opencode run --model "${{ inputs.model }}" --agent "${{ inputs.agent }}" > ${{ inputs.run-name }}-results.txt
          elif [ -n "${{ inputs.prompt-file }}" ]; then
            PROMPT=$(cat ${{ inputs.prompt-file }})
            echo "$PROMPT" | env -i PATH="$HOME/.opencode/bin:$PATH" HOME="$HOME" opencode run --model "${{ inputs.model }}" --agent "${{ inputs.agent }}" > ${{ inputs.run-name }}-results.txt
          else
            echo "Error: At least one of 'command', 'prompt', or 'prompt-file' must be provided" >&2
            exit 1
          fi

      - name: Upload ${{ inputs.run-name }} Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ inputs.run-name }}-results
          path: ${{ inputs.run-name }}-results.txt