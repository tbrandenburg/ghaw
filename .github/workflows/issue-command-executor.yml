name: Execute OpenCode Commands from Issue Comments

on:
  issue_comment:
    types: [created]

jobs:
  parse-and-check:
    # Only run if the comment author is the repository owner
    if: github.event.comment.author_association == 'OWNER'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    outputs:
      has-command: ${{ steps.parse-comment.outputs.has_command }}
      command: ${{ steps.parse-comment.outputs.command }}
      prompt: ${{ steps.parse-comment.outputs.prompt }}
      agent: ${{ steps.parse-comment.outputs.agent }}
      is-agent-command: ${{ steps.parse-comment.outputs.is_agent_command }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Parse comment for commands
        id: parse-comment
        run: |
          comment="${{ github.event.comment.body }}"
          echo "Original comment: $comment"
          
          # Check if comment contains a command or agent command
          if [[ "$comment" =~ ^\*([a-zA-Z0-9_-]+)[[:space:]]+/([a-zA-Z0-9_-]+)(.*)$ ]]; then
            # Agent command format: *agent /command PROMPT
            agent="${BASH_REMATCH[1]}"
            command="${BASH_REMATCH[2]}"
            prompt="${BASH_REMATCH[3]}"
            # Remove leading whitespace from prompt
            prompt=$(echo "$prompt" | sed 's/^[[:space:]]*//')
            
            echo "Detected agent command"
            echo "agent=$agent" >> $GITHUB_OUTPUT
            echo "command=$command" >> $GITHUB_OUTPUT
            echo "prompt<<EOF" >> $GITHUB_OUTPUT
            echo "$prompt" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_command=true" >> $GITHUB_OUTPUT
            echo "is_agent_command=true" >> $GITHUB_OUTPUT
            
          elif [[ "$comment" =~ ^/([a-zA-Z0-9_-]+)(.*)$ ]]; then
            # Direct command format: /command PROMPT
            command="${BASH_REMATCH[1]}"
            prompt="${BASH_REMATCH[2]}"
            # Remove leading whitespace from prompt
            prompt=$(echo "$prompt" | sed 's/^[[:space:]]*//')
            
            echo "Detected direct command"
            echo "command=$command" >> $GITHUB_OUTPUT
            echo "prompt<<EOF" >> $GITHUB_OUTPUT
            echo "$prompt" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_command=true" >> $GITHUB_OUTPUT
            echo "is_agent_command=false" >> $GITHUB_OUTPUT
            
          else
            echo "No command detected in comment"
            echo "has_command=false" >> $GITHUB_OUTPUT
          fi

  execute-opencode:
    if: needs.parse-and-check.outputs.has-command == 'true'
    needs: parse-and-check
    uses: ./.github/workflows/opencode-run.yml
    with:
      run-name: "issue-${{ github.event.issue.number }}-comment-${{ github.event.comment.id }}"
      command: ${{ needs.parse-and-check.outputs.command }}
      prompt: ${{ needs.parse-and-check.outputs.prompt }}
      agent: ${{ needs.parse-and-check.outputs.is-agent-command == 'true' && needs.parse-and-check.outputs.agent || 'build' }}
      timeout-minutes: 30

  comment-results:
    if: needs.parse-and-check.outputs.has-command == 'true' && always()
    needs: [parse-and-check, execute-opencode]
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:      
      - name: Comment execution results
        uses: actions/github-script@v7
        with:
          script: |
            const command = '${{ needs.parse-and-check.outputs.command }}';
            const isAgentCommand = '${{ needs.parse-and-check.outputs.is-agent-command }}' === 'true';
            const agent = '${{ needs.parse-and-check.outputs.agent }}';
            const runId = context.runId;
            
            const results = `${{ needs.execute-opencode.outputs.results }}`;
            const resultsTruncated = '${{ needs.execute-opencode.outputs.results-truncated }}' === 'true';
            const artifactName = '${{ needs.execute-opencode.outputs.artifact-name }}';
            
            let executionType;
            if (isAgentCommand) {
              executionType = `*${agent} /${command} (agent command)`;
            } else {
              executionType = `/${command} (direct command)`;
            }
            
            let commentBody;
            if (results && results.trim() !== '' && results !== '‚ùå No results file generated') {
              const truncationNote = resultsTruncated ? 
                '\n\nüìé **Full results available in artifact:** [' + artifactName + '](' + context.payload.repository.html_url + '/actions/runs/' + runId + ')' : '';
              
              commentBody = 'ü§ñ **OpenCode Execution Complete**\n\n' +
                '**Command:** `' + executionType + '`\n' +
                '**Run ID:** ' + runId + '\n' +
                '**Status:** ‚úÖ Completed\n\n' +
                '## Results\n\n' +
                results + truncationNote;
            } else {
              commentBody = 'ü§ñ **OpenCode Execution Complete**\n\n' +
                '**Command:** `' + executionType + '`\n' +
                '**Run ID:** ' + runId + '\n' +
                '**Status:** ‚ö†Ô∏è No output generated\n\n' +
                'üìé **Check the full logs:** [View run details](' + context.payload.repository.html_url + '/actions/runs/' + runId + ')';
            }

            return await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });